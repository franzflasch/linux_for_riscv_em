From 033489182d713653a9670335e3fcf16c65a9c8fd Mon Sep 17 00:00:00 2001
From: Franz Flasch <franz.flasch@gmx.at>
Date: Sat, 10 Sep 2022 06:42:07 +0000
Subject: [PATCH] add simple uart

---
 include/sbi_utils/fdt/fdt_helper.h        |  3 ++
 include/sbi_utils/serial/simple-uart.h    | 22 +++++++++++++
 lib/utils/fdt/fdt_helper.c                | 17 ++++++++++
 lib/utils/serial/fdt_serial_simple_uart.c | 36 +++++++++++++++++++++
 lib/utils/serial/objects.mk               |  4 +++
 lib/utils/serial/simple-uart.c            | 38 +++++++++++++++++++++++
 6 files changed, 120 insertions(+)
 create mode 100644 include/sbi_utils/serial/simple-uart.h
 create mode 100644 lib/utils/serial/fdt_serial_simple_uart.c
 create mode 100644 lib/utils/serial/simple-uart.c

diff --git a/include/sbi_utils/fdt/fdt_helper.h b/include/sbi_utils/fdt/fdt_helper.h
index c60af35..f8db9f0 100644
--- a/include/sbi_utils/fdt/fdt_helper.h
+++ b/include/sbi_utils/fdt/fdt_helper.h
@@ -74,6 +74,9 @@ int fdt_parse_uart8250(void *fdt, struct platform_uart_data *uart,
 int fdt_parse_xlnx_uartlite_node(void *fdt, int nodeoffset,
 			       struct platform_uart_data *uart);
 
+int fdt_parse_simple_uart_node(void *fdt, int nodeoffset,
+			    struct platform_uart_data *uart);
+
 struct aplic_data;
 
 int fdt_parse_aplic_node(void *fdt, int nodeoff, struct aplic_data *aplic);
diff --git a/include/sbi_utils/serial/simple-uart.h b/include/sbi_utils/serial/simple-uart.h
new file mode 100644
index 0000000..d92647e
--- /dev/null
+++ b/include/sbi_utils/serial/simple-uart.h
@@ -0,0 +1,22 @@
+/*
+ * SPDX-License-Identifier: BSD-2-Clause
+ *
+ * Copyright (c) 2019 Western Digital Corporation or its affiliates.
+ *
+ * Authors:
+ *   Anup Patel <anup.patel@wdc.com>
+ */
+
+#ifndef __SERIAL_SIMPLE_UART_H__
+#define __SERIAL_SIMPLE_UART_H__
+
+#include <sbi/sbi_types.h>
+
+void simple_uart_putc(char ch);
+
+int simple_uart_getc(void);
+
+int simple_uart_init(unsigned long base, u32 in_freq, u32 baudrate, u32 reg_shift,
+		  u32 reg_width);
+
+#endif
diff --git a/lib/utils/fdt/fdt_helper.c b/lib/utils/fdt/fdt_helper.c
index 2bdb1ef..b4574f0 100644
--- a/lib/utils/fdt/fdt_helper.c
+++ b/lib/utils/fdt/fdt_helper.c
@@ -773,6 +773,23 @@ int fdt_parse_imsic_node(void *fdt, int nodeoff, struct imsic_data *imsic)
 	return 0;
 }
 
+int fdt_parse_simple_uart_node(void *fdt, int nodeoffset,
+			    			   struct platform_uart_data *uart)
+{
+	int rc;
+	uint64_t reg_addr, reg_size;
+
+	if (nodeoffset < 0 || !uart || !fdt)
+		return SBI_ENODEV;
+
+	rc = fdt_get_node_addr_size(fdt, nodeoffset, 0, &reg_addr, &reg_size);
+	if (rc < 0 || !reg_addr || !reg_size)
+		return SBI_ENODEV;
+	uart->addr = reg_addr;
+
+	return 0;
+}
+
 int fdt_parse_plic_node(void *fdt, int nodeoffset, struct plic_data *plic)
 {
 	int len, rc;
diff --git a/lib/utils/serial/fdt_serial_simple_uart.c b/lib/utils/serial/fdt_serial_simple_uart.c
new file mode 100644
index 0000000..a63dbde
--- /dev/null
+++ b/lib/utils/serial/fdt_serial_simple_uart.c
@@ -0,0 +1,36 @@
+/*
+ * SPDX-License-Identifier: BSD-2-Clause
+ *
+ * Copyright (c) 2020 Western Digital Corporation or its affiliates.
+ *
+ * Authors:
+ *   Anup Patel <anup.patel@wdc.com>
+ */
+
+#include <sbi_utils/fdt/fdt_helper.h>
+#include <sbi_utils/serial/fdt_serial.h>
+#include <sbi_utils/serial/simple-uart.h>
+
+static int serial_simple_uart_init(void *fdt, int nodeoff,
+				const struct fdt_match *match)
+{
+	int rc;
+	struct platform_uart_data uart;
+
+	rc = fdt_parse_simple_uart_node(fdt, nodeoff, &uart);
+	if (rc)
+		return rc;
+
+	return simple_uart_init(uart.addr, uart.freq, uart.baud,
+			     uart.reg_shift, uart.reg_io_width);
+}
+
+static const struct fdt_match serial_simple_uart_match[] = {
+	{ .compatible = "simple-uart" },
+	{ },
+};
+
+struct fdt_serial fdt_serial_simple_uart = {
+	.match_table = serial_simple_uart_match,
+	.init = serial_simple_uart_init,
+};
diff --git a/lib/utils/serial/objects.mk b/lib/utils/serial/objects.mk
index d26a74e..4fdf50c 100644
--- a/lib/utils/serial/objects.mk
+++ b/lib/utils/serial/objects.mk
@@ -31,9 +31,13 @@ libsbiutils-objs-y += serial/fdt_serial_uart8250.o
 carray-fdt_serial_drivers-y += fdt_serial_xlnx_uartlite
 libsbiutils-objs-y += serial/fdt_serial_xlnx_uartlite.o
 
+carray-fdt_serial_drivers-y += fdt_serial_simple_uart
+libsbiutils-objs-y += serial/fdt_serial_simple_uart.o
+
 libsbiutils-objs-y += serial/gaisler-uart.o
 libsbiutils-objs-y += serial/shakti-uart.o
 libsbiutils-objs-y += serial/sifive-uart.o
 libsbiutils-objs-y += serial/litex-uart.o
 libsbiutils-objs-y += serial/uart8250.o
 libsbiutils-objs-y += serial/xlnx-uartlite.o
+libsbiutils-objs-y += serial/simple-uart.o
diff --git a/lib/utils/serial/simple-uart.c b/lib/utils/serial/simple-uart.c
new file mode 100644
index 0000000..dde3968
--- /dev/null
+++ b/lib/utils/serial/simple-uart.c
@@ -0,0 +1,38 @@
+/*
+ * SPDX-License-Identifier: BSD-2-Clause
+ *
+ * Copyright (c) 2019 Western Digital Corporation or its affiliates.
+ *
+ * Authors:
+ *   Anup Patel <anup.patel@wdc.com>
+ */
+
+#include <sbi/riscv_io.h>
+#include <sbi/sbi_console.h>
+#include <sbi_utils/serial/simple-uart.h>
+
+static volatile void *simple_uart_base;
+
+void simple_uart_putc(char ch)
+{
+	writeb(ch, simple_uart_base);
+}
+
+int simple_uart_getc(void)
+{
+	return readb(simple_uart_base);
+}
+
+static struct sbi_console_device simple_uart_console = {
+	.name = "simple_uart",
+	.console_putc = simple_uart_putc,
+	.console_getc = simple_uart_getc
+};
+
+int simple_uart_init(unsigned long base, u32 in_freq, u32 baudrate, u32 reg_shift,
+		  u32 reg_width)
+{
+	simple_uart_base      = (volatile void *)base;
+	sbi_console_set_device(&simple_uart_console);
+	return 0;
+}
-- 
2.25.1

